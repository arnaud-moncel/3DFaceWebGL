<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec2 vTextureCoord;
    varying vec3 vNormal;
    varying vec3 vMvPosition;

    uniform mat3 uNMatrix;

    //texture
    uniform sampler2D diffTexture;
    uniform sampler2D redNormals;
    uniform sampler2D greenNormals;
    uniform sampler2D blueNormals;
    uniform sampler2D specNormals;
    uniform sampler2D specTexture;

    //light information
    uniform int enabledLights[8];
    uniform vec3 lightPos[8];
    uniform vec3 lightDirection[8];
    uniform vec3 lightAmbient[8];
    uniform vec3 lightDiffuse[8];
    uniform vec3 lightSpecular[8];
    uniform float lightCutoff[8];

    //material information
    uniform vec3 materialAmbient;
    uniform vec3 materialDiffuse;
    uniform vec3 materialSpecular;

    void main(void)
    {
        //textures variables
        vec3 textureColor = texture2D(diffTexture, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;
        vec3 specColor = texture2D(specTexture, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;

        //normal variables
        vec3 norm = normalize(uNMatrix * vNormal);
        vec3 normR = texture2D(redNormals, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;
        vec3 normG = texture2D(greenNormals, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;
        vec3 normB = texture2D(blueNormals, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;
        vec3 normS =  texture2D(specNormals, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;

        //adjust normal
        normR = normR * 2.0 - 1.0;
        normR = normalize(uNMatrix * normR);

        normG = normG * 2.0 - 1.0;
        normG = normalize(uNMatrix * normG);

        normB = normB * 2.0 - 1.0;
        normB = normalize(uNMatrix * normB);

        normS = normS * 2.0 - 1.0;
        normS = normalize(uNMatrix * normS);


        float Ka = 1.0;
        float Kd = 2.5;
        float Ks = 0.8;
        float specPow = 5.0;

        vec3 Ia = vec3(0.0, 0.0, 0.0);
        vec3 Id = vec3(0.0, 0.0, 0.0);
        vec3 Is = vec3(0.0, 0.0, 0.0);

        float nbLight = 0.0;

        //for each light
        for(int i=0; i<8; i++)
        {
            if(enabledLights[i] == 1)
            {
                //ambient
                Ia += lightAmbient[i] * materialAmbient * Ka;

                //diffuse
                vec3 L = lightPos[i] - vMvPosition;
                L = normalize(L);

                //todo test
                /*float thetaR = dot(L, normR);
                thetaR = max(thetaR, 0.0);

                float thetaG = dot(L, normG);
                thetaG = max(thetaG, 0.0);

                float thetaB = dot(L, normB);
                thetaB = max(thetaB, 0.0);

                Id += lightDiffuse[i] * textureColor * materialDiffuse * Kd * vec3(thetaR, thetaG, thetaB);*/

                float theta = dot(L, norm);
                theta = max(theta, 0.0);

                Id += lightDiffuse[i] * textureColor * materialDiffuse * Kd * theta;

                //specular
                vec3 V = -vMvPosition;
                V = normalize(V);
                //vec3 R = 2.0 * dot(norm, V) * normS - V;
                vec3 R = 2.0 * dot(norm, V) * norm - V;
                R = normalize(R);

                float alpha = dot(L, R);
                alpha = max(alpha, 0.0);

                Is += lightSpecular[i] * specColor * materialSpecular * Ks * pow(alpha, specPow);

                nbLight++;
            }
        }

        Ia /= nbLight;
        Id /= nbLight;
        Is /= nbLight;

        vec3 I = Ia + Id + Is;

        gl_FragColor = vec4(I, 1.0);
    }
</script>