<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec2 vTextureCoord;
    varying vec3 vNormal;
    varying vec3 vMvPosition;

    uniform mat3 uNMatrix;

    //texture
    uniform sampler2D diffTexture;
    uniform sampler2D redNormals;
    uniform sampler2D greenNormals;
    uniform sampler2D blueNormals;
    uniform sampler2D specNormals;
    uniform sampler2D specTexture;

    //light information
    uniform int enabledLights[8];
    uniform vec3 lightPos[8];
    uniform vec3 lightDirection[8];
    uniform vec3 lightAmbient[8];
    uniform vec3 lightDiffuse[8];
    uniform vec3 lightSpecular[8];
    uniform float lightCutoff[8];

    //material information
    uniform vec3 materialAmbient;
    uniform vec3 materialDiffuse;
    uniform vec3 materialSpecular;

    /*float getColour(vec3 normal, vec3 lightDir, float col)
    {
        vec3 transformedNormal = normalize(uNMatrix * normal);
        float directionalLightWeighting = col*max(dot(transformedNormal.xyz, lightDir), 0.0);
        return directionalLightWeighting;
    }

    vec3 getSpecular(vec3 normal, vec3 lightDir, vec3 viewDir, float specPow, vec3 col)
    {
        vec3 transformedNormal =normalize(uNMatrix * normal);
        vec3 reflectDir = normalize(reflect(lightDir, transformedNormal));
        float specAngle = max(dot(reflectDir, viewDir), 0.0);//max(dot(transformedNormal.xyz, lightDir), 0.0);//
        float specular = pow(specAngle, specPow);
        return vec3(specular)*col;
    }

    vec3 adjustNormal(vec4 normal)
    {
        normal.x=normal.x*2.0-1.0;
        normal.y=normal.y*2.0-1.0;
        normal.z=normal.z*2.0-1.0;
        return normalize(normal.xyz);
    }*/

    void main(void)
    {
        //variables
        vec3 norm = normalize(uNMatrix * vNormal);
        vec3 textureColor = texture2D(diffTexture, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;
        vec3 specColor = texture2D(specTexture, vec2(vTextureCoord.s, vTextureCoord.t)).rgb;

        float Ka = 1.0;
        float Kd = 2.5;
        float Ks = 0.8;
        float specPow = 5.0;

        vec3 Ia = vec3(0.0, 0.0, 0.0);
        vec3 Id = vec3(0.0, 0.0, 0.0);
        vec3 Is = vec3(0.0, 0.0, 0.0);

        float nbLight = 0.0;

        //for each light
        for(int i=0; i<8; i++)
        {
            if(enabledLights[i] == 1)
            {
                //ambient
                Ia += lightAmbient[i] * materialAmbient * Ka;

                //diffuse
                vec3 L = lightPos[i] - vMvPosition;
                L = normalize(L);

                float theta = dot(L, norm);
                theta = max(theta, 0.0);

                Id += lightDiffuse[i] * textureColor * materialDiffuse * Kd * theta;

                //specular
                vec3 V = -vMvPosition;
                V = normalize(V);
                vec3 R = 2.0 * dot(norm, V) * norm - V;
                R = normalize(R);

                float alpha = dot(L, R);
                alpha = max(alpha, 0.0);

                Is += lightSpecular[i] * materialSpecular * Ks * pow(alpha, specPow);

                nbLight++;
            }
        }

        Ia /= nbLight;
        Id /= nbLight;
        Is /= nbLight;

        vec3 I = Ia + Id + Is;

        /*vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        vec4 specColor = texture2D(uSpecular, vec2(vTextureCoord.s, vTextureCoord.t));
        vec3 redNormal = adjustNormal(texture2D(uRedNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
        vec3 greenNormal =  adjustNormal(texture2D(uGreenNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
        vec3 blueNormal =  adjustNormal(texture2D(uBlueNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
        vec3 specNormal =  adjustNormal(texture2D(uSpecNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
        vec3 lightDirection = normalize(uPointLightingLocation - vMvPosition);
        // vec3 lightDirection = vec3(0, 0, 1);
        float diffRed = getColour(redNormal, lightDirection, textureColor.r)*uPointLightingColor.r;
        float diffGreen = getColour(greenNormal, lightDirection, textureColor.g)*uPointLightingColor.g;
        float diffBlue = getColour(blueNormal, lightDirection, textureColor.b)*uPointLightingColor.b;
        vec3 viewDir =  normalize(vMvPosition);//vec3(0, 0, 1);//
        vec3 specCol = getSpecular(specNormal, lightDirection, viewDir, uSpecPow, specColor.rgb*uPointLightingColor.rgb);
        vec3 col = (uAmbientColor + vec3(diffRed, diffGreen, diffBlue)+specCol);*/

        gl_FragColor = vec4(I, 1.0);
    }
</script>