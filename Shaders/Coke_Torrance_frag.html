<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec2 vTextureCoord;
    varying vec3 vMvPosition;

    uniform mat3 uNMatrix;

    uniform vec3 uAmbientColor;

    uniform vec3 uPointLightingLocation;
    uniform vec3 uPointLightingColor;

    uniform sampler2D uSampler;
    uniform sampler2D uRedNormals;
    uniform sampler2D uGreenNormals;
    uniform sampler2D uBlueNormals;
    uniform sampler2D uSpecNormals;
    uniform sampler2D uSpecular;
    uniform float uSpecPow;

    float getColour(vec3 normal, vec3 lightDir, float col) {
      vec3 transformedNormal = normalize(uNMatrix * normal);
        float directionalLightWeighting = col*max(dot(transformedNormal.xyz, lightDir), 0.0);
        return directionalLightWeighting;
    }

    vec3 getSpecular(vec3 normal, vec3 lightDir, vec3 viewDir, float specPow, vec3 col) {
      vec3 transformedNormal =normalize(uNMatrix * normal);
      vec3 reflectDir = normalize(reflect(lightDir, transformedNormal));
      float specAngle = max(dot(reflectDir, viewDir), 0.0);//max(dot(transformedNormal.xyz, lightDir), 0.0);//
      float specular = pow(specAngle, specPow);
        return vec3(specular)*col;
    }

    vec3 adjustNormal(vec4 normal) {
       normal.x=normal.x*2.0-1.0;
       normal.y=normal.y*2.0-1.0;
       normal.z=normal.z*2.0-1.0;
       return normalize(normal.xyz);
    }

    void main(void) {
        vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        vec4 specColor = texture2D(uSpecular, vec2(vTextureCoord.s, vTextureCoord.t));
        vec3 redNormal = adjustNormal(texture2D(uRedNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
         vec3 greenNormal =  adjustNormal(texture2D(uGreenNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
         vec3 blueNormal =  adjustNormal(texture2D(uBlueNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
         vec3 specNormal =  adjustNormal(texture2D(uSpecNormals, vec2(vTextureCoord.s, vTextureCoord.t)));
         vec3 lightDirection = normalize(uPointLightingLocation - vMvPosition);
       // vec3 lightDirection = vec3(0, 0, 1);
        float diffRed = getColour(redNormal, lightDirection, textureColor.r)*uPointLightingColor.r;
        float diffGreen = getColour(greenNormal, lightDirection, textureColor.g)*uPointLightingColor.g;
        float diffBlue = getColour(blueNormal, lightDirection, textureColor.b)*uPointLightingColor.b;
        vec3 viewDir =  normalize(vMvPosition);//vec3(0, 0, 1);//
        vec3 specCol = getSpecular(specNormal, lightDirection, viewDir, uSpecPow, specColor.rgb*uPointLightingColor.rgb);
        vec3 col = (uAmbientColor + vec3(diffRed, diffGreen, diffBlue)+specCol);

        gl_FragColor = vec4(col, textureColor.a);
    }
</script>